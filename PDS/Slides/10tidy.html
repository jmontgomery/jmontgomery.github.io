<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>dplyr and tidy</title>
    <meta charset="utf-8" />
    <meta name="date" content="2020-01-01" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# dplyr and tidy
### <div class="line-block">Jacob M. Montgomery<br />
<em>Washington University in St.Â Louis</em><br />
<em>Department of Politcal Science</em></div>
### 2020

---



## Orientation for today

**Last time**



**Before**

1. Basic data viz
    
&lt;br&gt;

--

**Today**

1. Data wrangling
    + Recoding data
    + Subsetting
    + Reshaping
    
    
--

**Next class**
1. Relational data
    

---

## Into the tidyverse

- `dplyr` is a handy package for changing data
- `tidyr` is a handy package for reshaping data
- In combination they offer a powerful way to quickly extract insight from your data



---

## Running example


Data comes from fivethirtyeight.com

```r
library(dplyr)
library(tidyr)
library(readr)
primaryPolls&lt;-read_csv('https://jmontgomery.github.io/PDS/Datasets/president_primary_polls_feb2020.csv')
primaryPolls$start_date&lt;-as.Date(primaryPolls$start_date, "%m/%d/%y")
```


---

### Data object



```r
class(primaryPolls)
```

```
## [1] "spec_tbl_df" "tbl_df"      "tbl"         "data.frame"
```

- A tibble is basically a data frame 
- They are both friendlier and more structured than traditional data frames


---


```r
primaryPolls
```

```
## # A tibble: 16,661 x 33
##    question_id poll_id cycle state pollster_id pollster sponsor_ids sponsors
##          &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;   
##  1      116805   63512  2020 New ~        1515 Data fo~          NA &lt;NA&gt;    
##  2      116805   63512  2020 New ~        1515 Data fo~          NA &lt;NA&gt;    
##  3      116805   63512  2020 New ~        1515 Data fo~          NA &lt;NA&gt;    
##  4      116805   63512  2020 New ~        1515 Data fo~          NA &lt;NA&gt;    
##  5      116805   63512  2020 New ~        1515 Data fo~          NA &lt;NA&gt;    
##  6      116805   63512  2020 New ~        1515 Data fo~          NA &lt;NA&gt;    
##  7      116805   63512  2020 New ~        1515 Data fo~          NA &lt;NA&gt;    
##  8      116805   63512  2020 New ~        1515 Data fo~          NA &lt;NA&gt;    
##  9      116799   63511  2020 &lt;NA&gt;          744 Ipsos             71 Reuters 
## 10      116799   63511  2020 &lt;NA&gt;          744 Ipsos             71 Reuters 
## # ... with 16,651 more rows, and 25 more variables: display_name &lt;chr&gt;,
## #   pollster_rating_id &lt;dbl&gt;, pollster_rating_name &lt;chr&gt;, fte_grade &lt;chr&gt;,
## #   sample_size &lt;dbl&gt;, population &lt;chr&gt;, population_full &lt;chr&gt;,
## #   methodology &lt;chr&gt;, office_type &lt;chr&gt;, start_date &lt;date&gt;, end_date &lt;chr&gt;,
## #   sponsor_candidate &lt;lgl&gt;, internal &lt;lgl&gt;, partisan &lt;lgl&gt;, tracking &lt;lgl&gt;,
## #   nationwide_batch &lt;lgl&gt;, created_at &lt;chr&gt;, notes &lt;chr&gt;, url &lt;chr&gt;,
## #   stage &lt;chr&gt;, party &lt;chr&gt;, answer &lt;chr&gt;, candidate_id &lt;dbl&gt;,
## #   candidate_name &lt;chr&gt;, pct &lt;dbl&gt;
```


---


```r
print(primaryPolls, width=Inf)
```

```
## # A tibble: 16,661 x 33
##    question_id poll_id cycle state         pollster_id pollster         
##          &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;               &lt;dbl&gt; &lt;chr&gt;            
##  1      116805   63512  2020 New Hampshire        1515 Data for Progress
##  2      116805   63512  2020 New Hampshire        1515 Data for Progress
##  3      116805   63512  2020 New Hampshire        1515 Data for Progress
##  4      116805   63512  2020 New Hampshire        1515 Data for Progress
##  5      116805   63512  2020 New Hampshire        1515 Data for Progress
##  6      116805   63512  2020 New Hampshire        1515 Data for Progress
##  7      116805   63512  2020 New Hampshire        1515 Data for Progress
##  8      116805   63512  2020 New Hampshire        1515 Data for Progress
##  9      116799   63511  2020 &lt;NA&gt;                  744 Ipsos            
## 10      116799   63511  2020 &lt;NA&gt;                  744 Ipsos            
##    sponsor_ids sponsors display_name      pollster_rating_id
##          &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;                          &lt;dbl&gt;
##  1          NA &lt;NA&gt;     Data for Progress                522
##  2          NA &lt;NA&gt;     Data for Progress                522
##  3          NA &lt;NA&gt;     Data for Progress                522
##  4          NA &lt;NA&gt;     Data for Progress                522
##  5          NA &lt;NA&gt;     Data for Progress                522
##  6          NA &lt;NA&gt;     Data for Progress                522
##  7          NA &lt;NA&gt;     Data for Progress                522
##  8          NA &lt;NA&gt;     Data for Progress                522
##  9          71 Reuters  Ipsos                            154
## 10          71 Reuters  Ipsos                            154
##    pollster_rating_name fte_grade sample_size population population_full
##    &lt;chr&gt;                &lt;chr&gt;           &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;          
##  1 Data for Progress    B/C              1295 lv         lv-d           
##  2 Data for Progress    B/C              1295 lv         lv-d           
##  3 Data for Progress    B/C              1295 lv         lv-d           
##  4 Data for Progress    B/C              1295 lv         lv-d           
##  5 Data for Progress    B/C              1295 lv         lv-d           
##  6 Data for Progress    B/C              1295 lv         lv-d           
##  7 Data for Progress    B/C              1295 lv         lv-d           
##  8 Data for Progress    B/C              1295 lv         lv-d           
##  9 Ipsos                B-                556 rv         rv-d           
## 10 Ipsos                B-                556 rv         rv-d           
##    methodology office_type    start_date end_date sponsor_candidate internal
##    &lt;chr&gt;       &lt;chr&gt;          &lt;date&gt;     &lt;chr&gt;    &lt;lgl&gt;             &lt;lgl&gt;   
##  1 Text        U.S. President 2020-02-07 2/10/20  NA                FALSE   
##  2 Text        U.S. President 2020-02-07 2/10/20  NA                FALSE   
##  3 Text        U.S. President 2020-02-07 2/10/20  NA                FALSE   
##  4 Text        U.S. President 2020-02-07 2/10/20  NA                FALSE   
##  5 Text        U.S. President 2020-02-07 2/10/20  NA                FALSE   
##  6 Text        U.S. President 2020-02-07 2/10/20  NA                FALSE   
##  7 Text        U.S. President 2020-02-07 2/10/20  NA                FALSE   
##  8 Text        U.S. President 2020-02-07 2/10/20  NA                FALSE   
##  9 Online      U.S. President 2020-02-06 2/10/20  NA                FALSE   
## 10 Online      U.S. President 2020-02-06 2/10/20  NA                FALSE   
##    partisan tracking nationwide_batch created_at    notes
##    &lt;lgl&gt;    &lt;lgl&gt;    &lt;lgl&gt;            &lt;chr&gt;         &lt;chr&gt;
##  1 NA       FALSE    FALSE            2/10/20 21:47 &lt;NA&gt; 
##  2 NA       FALSE    FALSE            2/10/20 21:47 &lt;NA&gt; 
##  3 NA       FALSE    FALSE            2/10/20 21:47 &lt;NA&gt; 
##  4 NA       FALSE    FALSE            2/10/20 21:47 &lt;NA&gt; 
##  5 NA       FALSE    FALSE            2/10/20 21:47 &lt;NA&gt; 
##  6 NA       FALSE    FALSE            2/10/20 21:47 &lt;NA&gt; 
##  7 NA       FALSE    FALSE            2/10/20 21:47 &lt;NA&gt; 
##  8 NA       FALSE    FALSE            2/10/20 21:47 &lt;NA&gt; 
##  9 NA       FALSE    FALSE            2/10/20 18:27 &lt;NA&gt; 
## 10 NA       FALSE    FALSE            2/10/20 18:27 &lt;NA&gt; 
##    url                                                                          
##    &lt;chr&gt;                                                                        
##  1 http://filesforprogress.org/datasets/2020/2/nh/new_hampshire_primary.pdf     
##  2 http://filesforprogress.org/datasets/2020/2/nh/new_hampshire_primary.pdf     
##  3 http://filesforprogress.org/datasets/2020/2/nh/new_hampshire_primary.pdf     
##  4 http://filesforprogress.org/datasets/2020/2/nh/new_hampshire_primary.pdf     
##  5 http://filesforprogress.org/datasets/2020/2/nh/new_hampshire_primary.pdf     
##  6 http://filesforprogress.org/datasets/2020/2/nh/new_hampshire_primary.pdf     
##  7 http://filesforprogress.org/datasets/2020/2/nh/new_hampshire_primary.pdf     
##  8 http://filesforprogress.org/datasets/2020/2/nh/new_hampshire_primary.pdf     
##  9 https://www.ipsos.com/sites/default/files/ct/news/documents/2020-02/topline_~
## 10 https://www.ipsos.com/sites/default/files/ct/news/documents/2020-02/topline_~
##    stage   party answer    candidate_id candidate_name        pct
##    &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;            &lt;dbl&gt; &lt;chr&gt;               &lt;dbl&gt;
##  1 primary DEM   Sanders          13257 Bernard Sanders        28
##  2 primary DEM   Yang             13329 Andrew Yang             5
##  3 primary DEM   Buttigieg        13345 Pete Buttigieg         26
##  4 primary DEM   Biden            13256 Joseph R. Biden Jr.     9
##  5 primary DEM   Gabbard          13343 Tulsi Gabbard           3
##  6 primary DEM   Klobuchar        13310 Amy Klobuchar          13
##  7 primary DEM   Warren           13258 Elizabeth Warren       14
##  8 primary DEM   Steyer           13327 Tom Steyer              3
##  9 primary DEM   Sanders          13257 Bernard Sanders        20
## 10 primary DEM   Biden            13256 Joseph R. Biden Jr.    17
## # ... with 16,651 more rows
```


---

- You can access elements basically the same way
- They never allow partial matching (which is evil anyways)
- You can use `as_tibble` or `as.data.frame` to jump back and forth


---

## Back to `dplyr`

- Subset data by rows: `filter`
- Reorder by rows: `arrange`
- Subset data by column: `select`
- Create new variables as a function of other variables: `mutate`
- Collapse values down (or extract statistic): `summarise`
- We can use `group_by` to make changes in the scope

---

## 10.1: `filter`

- `filter` allows you to easily subset data using conditions as we have done before using accessors


```r
filter(primaryPolls, candidate_name == c("Amy Klobuchar"))
```

```
## # A tibble: 874 x 33
##    question_id poll_id cycle state pollster_id pollster sponsor_ids sponsors
##          &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;   
##  1      116805   63512  2020 New ~        1515 Data fo~          NA &lt;NA&gt;    
##  2      116799   63511  2020 &lt;NA&gt;          744 Ipsos             71 Reuters 
##  3      116732   63489  2020 New ~        1102 Emerson~          43 7News   
##  4      116733   63490  2020 New ~         458 Suffolk~       68323 Boston ~
##  5      116743   63493  2020 New ~          23 America~          NA &lt;NA&gt;    
##  6      116798   63510  2020 New ~        1529 Elucd             NA &lt;NA&gt;    
##  7      116745   63494  2020 New ~        1470 Univers~         143 CNN     
##  8      116792   63508  2020 Cali~        1491 Capitol~          NA &lt;NA&gt;    
##  9      116763   63496  2020 &lt;NA&gt;          396 Quinnip~          NA &lt;NA&gt;    
## 10      116714   63483  2020 New ~        1102 Emerson~          43 7News   
## # ... with 864 more rows, and 25 more variables: display_name &lt;chr&gt;,
## #   pollster_rating_id &lt;dbl&gt;, pollster_rating_name &lt;chr&gt;, fte_grade &lt;chr&gt;,
## #   sample_size &lt;dbl&gt;, population &lt;chr&gt;, population_full &lt;chr&gt;,
## #   methodology &lt;chr&gt;, office_type &lt;chr&gt;, start_date &lt;date&gt;, end_date &lt;chr&gt;,
## #   sponsor_candidate &lt;lgl&gt;, internal &lt;lgl&gt;, partisan &lt;lgl&gt;, tracking &lt;lgl&gt;,
## #   nationwide_batch &lt;lgl&gt;, created_at &lt;chr&gt;, notes &lt;chr&gt;, url &lt;chr&gt;,
## #   stage &lt;chr&gt;, party &lt;chr&gt;, answer &lt;chr&gt;, candidate_id &lt;dbl&gt;,
## #   candidate_name &lt;chr&gt;, pct &lt;dbl&gt;
```

---

- Or you can include multiple conditions


```r
filter(primaryPolls, 
       candidate_name == c("Amy Klobuchar"), 
       state=="New Hampshire")
```

```
## # A tibble: 84 x 33
##    question_id poll_id cycle state pollster_id pollster sponsor_ids sponsors
##          &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;   
##  1      116805   63512  2020 New ~        1515 Data fo~          NA &lt;NA&gt;    
##  2      116732   63489  2020 New ~        1102 Emerson~          43 7News   
##  3      116733   63490  2020 New ~         458 Suffolk~       68323 Boston ~
##  4      116743   63493  2020 New ~          23 America~          NA &lt;NA&gt;    
##  5      116798   63510  2020 New ~        1529 Elucd             NA &lt;NA&gt;    
##  6      116745   63494  2020 New ~        1470 Univers~         143 CNN     
##  7      116714   63483  2020 New ~        1102 Emerson~          43 7News   
##  8      116715   63484  2020 New ~         458 Suffolk~       68323 Boston ~
##  9      116717   63485  2020 New ~        1470 Univers~         143 CNN     
## 10      116718   63486  2020 New ~         568 YouGov           133 CBS News
## # ... with 74 more rows, and 25 more variables: display_name &lt;chr&gt;,
## #   pollster_rating_id &lt;dbl&gt;, pollster_rating_name &lt;chr&gt;, fte_grade &lt;chr&gt;,
## #   sample_size &lt;dbl&gt;, population &lt;chr&gt;, population_full &lt;chr&gt;,
## #   methodology &lt;chr&gt;, office_type &lt;chr&gt;, start_date &lt;date&gt;, end_date &lt;chr&gt;,
## #   sponsor_candidate &lt;lgl&gt;, internal &lt;lgl&gt;, partisan &lt;lgl&gt;, tracking &lt;lgl&gt;,
## #   nationwide_batch &lt;lgl&gt;, created_at &lt;chr&gt;, notes &lt;chr&gt;, url &lt;chr&gt;,
## #   stage &lt;chr&gt;, party &lt;chr&gt;, answer &lt;chr&gt;, candidate_id &lt;dbl&gt;,
## #   candidate_name &lt;chr&gt;, pct &lt;dbl&gt;
```


- Everything you have already learned about boolean operators applies here.


---

## 10.2: `arrange`

- `arrange`  does the same thing, but organizes data by rows insead of subsetting by rows.


```r
arrange(primaryPolls, state, pollster_id)
```

```
## # A tibble: 16,661 x 33
##    question_id poll_id cycle state pollster_id pollster sponsor_ids sponsors
##          &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;   
##  1       99478   58691  2020 Alab~        1193 SurveyM~         132 NBC News
##  2       99478   58691  2020 Alab~        1193 SurveyM~         132 NBC News
##  3       99478   58691  2020 Alab~        1193 SurveyM~         132 NBC News
##  4       99478   58691  2020 Alab~        1193 SurveyM~         132 NBC News
##  5       99478   58691  2020 Alab~        1193 SurveyM~         132 NBC News
##  6       99478   58691  2020 Alab~        1193 SurveyM~         132 NBC News
##  7       99478   58691  2020 Alab~        1193 SurveyM~         132 NBC News
##  8       99478   58691  2020 Alab~        1193 SurveyM~         132 NBC News
##  9       99478   58691  2020 Alab~        1193 SurveyM~         132 NBC News
## 10       99478   58691  2020 Alab~        1193 SurveyM~         132 NBC News
## # ... with 16,651 more rows, and 25 more variables: display_name &lt;chr&gt;,
## #   pollster_rating_id &lt;dbl&gt;, pollster_rating_name &lt;chr&gt;, fte_grade &lt;chr&gt;,
## #   sample_size &lt;dbl&gt;, population &lt;chr&gt;, population_full &lt;chr&gt;,
## #   methodology &lt;chr&gt;, office_type &lt;chr&gt;, start_date &lt;date&gt;, end_date &lt;chr&gt;,
## #   sponsor_candidate &lt;lgl&gt;, internal &lt;lgl&gt;, partisan &lt;lgl&gt;, tracking &lt;lgl&gt;,
## #   nationwide_batch &lt;lgl&gt;, created_at &lt;chr&gt;, notes &lt;chr&gt;, url &lt;chr&gt;,
## #   stage &lt;chr&gt;, party &lt;chr&gt;, answer &lt;chr&gt;, candidate_id &lt;dbl&gt;,
## #   candidate_name &lt;chr&gt;, pct &lt;dbl&gt;
```


---

- Or in descending order


```r
arrange(primaryPolls, state, desc(pollster_id))
```

```
## # A tibble: 16,661 x 33
##    question_id poll_id cycle state pollster_id pollster sponsor_ids sponsors
##          &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;   
##  1       93812   57768  2020 Alab~        1365 Change ~          NA &lt;NA&gt;    
##  2       93812   57768  2020 Alab~        1365 Change ~          NA &lt;NA&gt;    
##  3       93812   57768  2020 Alab~        1365 Change ~          NA &lt;NA&gt;    
##  4       93812   57768  2020 Alab~        1365 Change ~          NA &lt;NA&gt;    
##  5       93812   57768  2020 Alab~        1365 Change ~          NA &lt;NA&gt;    
##  6       93812   57768  2020 Alab~        1365 Change ~          NA &lt;NA&gt;    
##  7       93812   57768  2020 Alab~        1365 Change ~          NA &lt;NA&gt;    
##  8       93812   57768  2020 Alab~        1365 Change ~          NA &lt;NA&gt;    
##  9       93812   57768  2020 Alab~        1365 Change ~          NA &lt;NA&gt;    
## 10       93812   57768  2020 Alab~        1365 Change ~          NA &lt;NA&gt;    
## # ... with 16,651 more rows, and 25 more variables: display_name &lt;chr&gt;,
## #   pollster_rating_id &lt;dbl&gt;, pollster_rating_name &lt;chr&gt;, fte_grade &lt;chr&gt;,
## #   sample_size &lt;dbl&gt;, population &lt;chr&gt;, population_full &lt;chr&gt;,
## #   methodology &lt;chr&gt;, office_type &lt;chr&gt;, start_date &lt;date&gt;, end_date &lt;chr&gt;,
## #   sponsor_candidate &lt;lgl&gt;, internal &lt;lgl&gt;, partisan &lt;lgl&gt;, tracking &lt;lgl&gt;,
## #   nationwide_batch &lt;lgl&gt;, created_at &lt;chr&gt;, notes &lt;chr&gt;, url &lt;chr&gt;,
## #   stage &lt;chr&gt;, party &lt;chr&gt;, answer &lt;chr&gt;, candidate_id &lt;dbl&gt;,
## #   candidate_name &lt;chr&gt;, pct &lt;dbl&gt;
```

---

## 10.3: `select`

- Select is just a much easier way to subset by column



```r
select(primaryPolls, state, candidate_name, start_date)
```

```
## # A tibble: 16,661 x 3
##    state         candidate_name      start_date
##    &lt;chr&gt;         &lt;chr&gt;               &lt;date&gt;    
##  1 New Hampshire Bernard Sanders     2020-02-07
##  2 New Hampshire Andrew Yang         2020-02-07
##  3 New Hampshire Pete Buttigieg      2020-02-07
##  4 New Hampshire Joseph R. Biden Jr. 2020-02-07
##  5 New Hampshire Tulsi Gabbard       2020-02-07
##  6 New Hampshire Amy Klobuchar       2020-02-07
##  7 New Hampshire Elizabeth Warren    2020-02-07
##  8 New Hampshire Tom Steyer          2020-02-07
##  9 &lt;NA&gt;          Bernard Sanders     2020-02-06
## 10 &lt;NA&gt;          Joseph R. Biden Jr. 2020-02-06
## # ... with 16,651 more rows
```


---

- It comes with a nice syntax for doing this without just listing
- `var1:var20` will select all columns between these two
- `-var1:var20` will select everything *except* that range
- `starts_with("cand")` will select columns that start with "cand"
- Similar functionality for `ends_with`, `contains`, and matches

---

A fun trick to move your favorite variables to the front, but keep it all:


```r
select(primaryPolls, state, candidate_name, start_date, everything())
```

```
## # A tibble: 16,661 x 33
##    state candidate_name start_date question_id poll_id cycle pollster_id
##    &lt;chr&gt; &lt;chr&gt;          &lt;date&gt;           &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt;
##  1 New ~ Bernard Sande~ 2020-02-07      116805   63512  2020        1515
##  2 New ~ Andrew Yang    2020-02-07      116805   63512  2020        1515
##  3 New ~ Pete Buttigieg 2020-02-07      116805   63512  2020        1515
##  4 New ~ Joseph R. Bid~ 2020-02-07      116805   63512  2020        1515
##  5 New ~ Tulsi Gabbard  2020-02-07      116805   63512  2020        1515
##  6 New ~ Amy Klobuchar  2020-02-07      116805   63512  2020        1515
##  7 New ~ Elizabeth War~ 2020-02-07      116805   63512  2020        1515
##  8 New ~ Tom Steyer     2020-02-07      116805   63512  2020        1515
##  9 &lt;NA&gt;  Bernard Sande~ 2020-02-06      116799   63511  2020         744
## 10 &lt;NA&gt;  Joseph R. Bid~ 2020-02-06      116799   63511  2020         744
## # ... with 16,651 more rows, and 26 more variables: pollster &lt;chr&gt;,
## #   sponsor_ids &lt;dbl&gt;, sponsors &lt;chr&gt;, display_name &lt;chr&gt;,
## #   pollster_rating_id &lt;dbl&gt;, pollster_rating_name &lt;chr&gt;, fte_grade &lt;chr&gt;,
## #   sample_size &lt;dbl&gt;, population &lt;chr&gt;, population_full &lt;chr&gt;,
## #   methodology &lt;chr&gt;, office_type &lt;chr&gt;, end_date &lt;chr&gt;,
## #   sponsor_candidate &lt;lgl&gt;, internal &lt;lgl&gt;, partisan &lt;lgl&gt;, tracking &lt;lgl&gt;,
## #   nationwide_batch &lt;lgl&gt;, created_at &lt;chr&gt;, notes &lt;chr&gt;, url &lt;chr&gt;,
## #   stage &lt;chr&gt;, party &lt;chr&gt;, answer &lt;chr&gt;, candidate_id &lt;dbl&gt;, pct &lt;dbl&gt;
```


---

- Note here that `rename` is the mythical easy way to rename a column, although syntax seems backwards


```r
basicPolls&lt;-select(primaryPolls, state, candidate_name, start_date, pct)
rename(basicPolls, candidate = candidate_name)
```

```
## # A tibble: 16,661 x 4
##    state         candidate           start_date   pct
##    &lt;chr&gt;         &lt;chr&gt;               &lt;date&gt;     &lt;dbl&gt;
##  1 New Hampshire Bernard Sanders     2020-02-07    28
##  2 New Hampshire Andrew Yang         2020-02-07     5
##  3 New Hampshire Pete Buttigieg      2020-02-07    26
##  4 New Hampshire Joseph R. Biden Jr. 2020-02-07     9
##  5 New Hampshire Tulsi Gabbard       2020-02-07     3
##  6 New Hampshire Amy Klobuchar       2020-02-07    13
##  7 New Hampshire Elizabeth Warren    2020-02-07    14
##  8 New Hampshire Tom Steyer          2020-02-07     3
##  9 &lt;NA&gt;          Bernard Sanders     2020-02-06    20
## 10 &lt;NA&gt;          Joseph R. Biden Jr. 2020-02-06    17
## # ... with 16,651 more rows
```

---


## 10.4: `mutate`: The glory

- `mutate` allows us to create a new variable that is a function of the others


```r
mutate(basicPolls, proportion=pct/100)
```

```
## # A tibble: 16,661 x 5
##    state         candidate_name      start_date   pct proportion
##    &lt;chr&gt;         &lt;chr&gt;               &lt;date&gt;     &lt;dbl&gt;      &lt;dbl&gt;
##  1 New Hampshire Bernard Sanders     2020-02-07    28       0.28
##  2 New Hampshire Andrew Yang         2020-02-07     5       0.05
##  3 New Hampshire Pete Buttigieg      2020-02-07    26       0.26
##  4 New Hampshire Joseph R. Biden Jr. 2020-02-07     9       0.09
##  5 New Hampshire Tulsi Gabbard       2020-02-07     3       0.03
##  6 New Hampshire Amy Klobuchar       2020-02-07    13       0.13
##  7 New Hampshire Elizabeth Warren    2020-02-07    14       0.14
##  8 New Hampshire Tom Steyer          2020-02-07     3       0.03
##  9 &lt;NA&gt;          Bernard Sanders     2020-02-06    20       0.2 
## 10 &lt;NA&gt;          Joseph R. Biden Jr. 2020-02-06    17       0.17
## # ... with 16,651 more rows
```

---




```r
transmute(basicPolls, proportion=pct/100)
```

```
## # A tibble: 16,661 x 1
##    proportion
##         &lt;dbl&gt;
##  1       0.28
##  2       0.05
##  3       0.26
##  4       0.09
##  5       0.03
##  6       0.13
##  7       0.14
##  8       0.03
##  9       0.2 
## 10       0.17
## # ... with 16,651 more rows
```


---


```r
transmute(primaryPolls, numberRespondents=round((pct/100)*sample_size))
```

```
## # A tibble: 16,661 x 1
##    numberRespondents
##                &lt;dbl&gt;
##  1               363
##  2                65
##  3               337
##  4               117
##  5                39
##  6               168
##  7               181
##  8                39
##  9               111
## 10                95
## # ... with 16,651 more rows
```

---



```r
transmute(primaryPolls, 
          proportion=pct/100,
          numberRespondents=round(proportion*sample_size)
          )
```

```
## # A tibble: 16,661 x 2
##    proportion numberRespondents
##         &lt;dbl&gt;             &lt;dbl&gt;
##  1       0.28               363
##  2       0.05                65
##  3       0.26               337
##  4       0.09               117
##  5       0.03                39
##  6       0.13               168
##  7       0.14               181
##  8       0.03                39
##  9       0.2                111
## 10       0.17                95
## # ... with 16,651 more rows
```

---

- Note that you can use a ton of the basic functions we have already covered like `sum`, `mean`, `sqrt`, etc.
- A useful one is `n()`, which just counts the number of observations
- This includes logical comparisons


```r
mutate(basicPolls, top_tier=(pct&gt;10)*1)
```

```
## # A tibble: 16,661 x 5
##    state         candidate_name      start_date   pct top_tier
##    &lt;chr&gt;         &lt;chr&gt;               &lt;date&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1 New Hampshire Bernard Sanders     2020-02-07    28        1
##  2 New Hampshire Andrew Yang         2020-02-07     5        0
##  3 New Hampshire Pete Buttigieg      2020-02-07    26        1
##  4 New Hampshire Joseph R. Biden Jr. 2020-02-07     9        0
##  5 New Hampshire Tulsi Gabbard       2020-02-07     3        0
##  6 New Hampshire Amy Klobuchar       2020-02-07    13        1
##  7 New Hampshire Elizabeth Warren    2020-02-07    14        1
##  8 New Hampshire Tom Steyer          2020-02-07     3        0
##  9 &lt;NA&gt;          Bernard Sanders     2020-02-06    20        1
## 10 &lt;NA&gt;          Joseph R. Biden Jr. 2020-02-06    17        1
## # ... with 16,651 more rows
```

---

## 10.5: `summarise`

- We can easily extract summary statistics



```r
summarise(basicPolls, average_candidate=mean(pct), count=n())
```

```
## # A tibble: 1 x 2
##   average_candidate count
##               &lt;dbl&gt; &lt;int&gt;
## 1              6.34 16661
```

---

- This is more powerful when also using the `group_by` function


```r
basicPolls_grouped&lt;-group_by(basicPolls, candidate_name)
summarise(basicPolls_grouped, average_candidate=mean(pct), count=n())
```

```
## # A tibble: 76 x 3
##    candidate_name   average_candidate count
##    &lt;chr&gt;                        &lt;dbl&gt; &lt;int&gt;
##  1 Amy Klobuchar                2.32    874
##  2 Andrew Cuomo                 0.433    12
##  3 Andrew Yang                  2.34    831
##  4 Barack Obama                 0         2
##  5 Ben Sasse                    0.711    36
##  6 Bernard Sanders             18.3     960
##  7 Beto O'Rourke                3.76    653
##  8 Bill de Blasio               0.534   318
##  9 Bob Corker                   0.611    36
## 10 Charles D. Baker            31.5       2
## # ... with 66 more rows
```

---


```r
basicPolls_grouped&lt;-group_by(basicPolls, candidate_name, state)
summarise(basicPolls_grouped, average_candidate=mean(pct), count=n())
```

```
## # A tibble: 1,024 x 4
## # Groups:   candidate_name [76]
##    candidate_name state      average_candidate count
##    &lt;chr&gt;          &lt;chr&gt;                  &lt;dbl&gt; &lt;int&gt;
##  1 Amy Klobuchar  Alabama                 1        3
##  2 Amy Klobuchar  Arizona                 1.18     6
##  3 Amy Klobuchar  California              1.74    40
##  4 Amy Klobuchar  Colorado                0.1      1
##  5 Amy Klobuchar  Delaware                1        1
##  6 Amy Klobuchar  Florida                 1.98    13
##  7 Amy Klobuchar  Georgia                 1.27     4
##  8 Amy Klobuchar  Illinois                2.15     2
##  9 Amy Klobuchar  Indiana                 0        1
## 10 Amy Klobuchar  Iowa                    5.97    61
## # ... with 1,014 more rows
```

---

## 10.6 Piping

- The tidyverse includes a nice syntax for combining multiple commands so we don't have to create new objects all of the time.
- The `%?%` syntax allows us to pass on the results of one line to another


```r
basicPolls %&gt;%
  group_by(candidate_name, state) %&gt;%
  summarise(average_candidate=mean(pct), count=n())
```

```
## # A tibble: 1,024 x 4
## # Groups:   candidate_name [76]
##    candidate_name state      average_candidate count
##    &lt;chr&gt;          &lt;chr&gt;                  &lt;dbl&gt; &lt;int&gt;
##  1 Amy Klobuchar  Alabama                 1        3
##  2 Amy Klobuchar  Arizona                 1.18     6
##  3 Amy Klobuchar  California              1.74    40
##  4 Amy Klobuchar  Colorado                0.1      1
##  5 Amy Klobuchar  Delaware                1        1
##  6 Amy Klobuchar  Florida                 1.98    13
##  7 Amy Klobuchar  Georgia                 1.27     4
##  8 Amy Klobuchar  Illinois                2.15     2
##  9 Amy Klobuchar  Indiana                 0        1
## 10 Amy Klobuchar  Iowa                    5.97    61
## # ... with 1,014 more rows
```

- See assigned readings for more useful summary variabels and `ungroup`


---


```r
basicPolls %&gt;%
  group_by(candidate_name, state) %&gt;%
  summarise(average_candidate=mean(pct), count=n()) %&gt;%
  filter(count&gt;10)
```

```
## # A tibble: 206 x 4
## # Groups:   candidate_name [44]
##    candidate_name state          average_candidate count
##    &lt;chr&gt;          &lt;chr&gt;                      &lt;dbl&gt; &lt;int&gt;
##  1 Amy Klobuchar  California                  1.74    40
##  2 Amy Klobuchar  Florida                     1.98    13
##  3 Amy Klobuchar  Iowa                        5.97    61
##  4 Amy Klobuchar  Nevada                      1.71    15
##  5 Amy Klobuchar  New Hampshire               5.42    84
##  6 Amy Klobuchar  Pennsylvania                1.53    11
##  7 Amy Klobuchar  South Carolina              1.27    34
##  8 Amy Klobuchar  Texas                       1.47    23
##  9 Amy Klobuchar  Wisconsin                   2.52    16
## 10 Amy Klobuchar  &lt;NA&gt;                        1.62   503
## # ... with 196 more rows
```

---



```r
primaryPolls %&gt;%
  group_by(candidate_name, state) %&gt;%
  summarise(average_candidate=mean(pct), count=n()) %&gt;%
  filter(count&gt;10) %&gt;%
  mutate(average_prop=average_candidate/100) %&gt;%
  select(average_prop, candidate_name, state, count)
```

```
## # A tibble: 206 x 4
## # Groups:   candidate_name [44]
##    average_prop candidate_name state          count
##           &lt;dbl&gt; &lt;chr&gt;          &lt;chr&gt;          &lt;int&gt;
##  1       0.0174 Amy Klobuchar  California        40
##  2       0.0198 Amy Klobuchar  Florida           13
##  3       0.0597 Amy Klobuchar  Iowa              61
##  4       0.0171 Amy Klobuchar  Nevada            15
##  5       0.0542 Amy Klobuchar  New Hampshire     84
##  6       0.0153 Amy Klobuchar  Pennsylvania      11
##  7       0.0127 Amy Klobuchar  South Carolina    34
##  8       0.0147 Amy Klobuchar  Texas             23
##  9       0.0252 Amy Klobuchar  Wisconsin         16
## 10       0.0162 Amy Klobuchar  &lt;NA&gt;             503
## # ... with 196 more rows
```


---

## Activity

- Filter the data so it includes only polls taken in the last two months
- Select down to only the start_date, pct, state, and candidate
- Create a new variabele that is the proportion of respondents in favor
- Find the median level of support for the top 10 candidates by state limited only to candidate/state combinations with at least 5 polls


---

## 10.7: Tidy data

- In many cases the data is not quite organized the way we want.
- Right now we have each poll as a separate row.  But what if we want each candidate to be a row so we can analyze their trends in polls over time?
- Or what if we get the trend line and want to instead reorganize to look at each poll separately?
- The key commands here are `pivot_wider` and `pivot_longer`
- See Chapter 12 for some additional (but less universally useful functions)


---

## 10.8: Pivots


- In our running example we have one entry for each poll.  How could we combine these to list the result from each unique poll togehter?
- The key here is that the *values* of interest are in the `pct` column and the *groupings* of interest are in the candidates column


```r
nevadaPrimaries&lt;-primaryPolls %&gt;%
 filter(candidate_name %in% c("Amy Klobuchar", "Bernard Sanders", "Elizabeth Warren", "Joseph R. Biden Jr.", "Michael Bloomberg", "Pete Buttigieg")) %&gt;%
  filter(state=="Nevada") %&gt;%
  select(candidate_name, pct, start_date, sample_size)
nevadaPrimaries
```

```
## # A tibble: 76 x 4
##    candidate_name        pct start_date sample_size
##    &lt;chr&gt;               &lt;dbl&gt; &lt;date&gt;           &lt;dbl&gt;
##  1 Joseph R. Biden Jr.  19.4 2020-01-08         500
##  2 Bernard Sanders      17.6 2020-01-08         500
##  3 Elizabeth Warren     10.6 2020-01-08         500
##  4 Pete Buttigieg        8.2 2020-01-08         500
##  5 Amy Klobuchar         3.6 2020-01-08         500
##  6 Elizabeth Warren     14   2020-01-06         600
##  7 Bernard Sanders      29   2020-01-06         600
##  8 Joseph R. Biden Jr.  28   2020-01-06         600
##  9 Pete Buttigieg        6   2020-01-06         600
## 10 Amy Klobuchar         4   2020-01-06         600
## # ... with 66 more rows
```

---



```r
wideNevada&lt;-pivot_wider(nevadaPrimaries, names_from = candidate_name, values_from = pct)
wideNevada
```

```
## # A tibble: 15 x 8
##    start_date sample_size `Joseph R. Bide~ `Bernard Sander~ `Elizabeth Warr~
##    &lt;date&gt;           &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;
##  1 2020-01-08         500             19.4             17.6             10.6
##  2 2020-01-06         600             28               29               14  
##  3 2020-01-05         635             23               17               12  
##  4 2019-11-10         627             24               18               18  
##  5 2019-11-06         626             33               23               21  
##  6 2019-10-31         451             29.9             18.8             22.2
##  7 2019-10-28         600             29.1             19.1             19.2
##  8 2019-09-22         324             22               22               18  
##  9 2019-09-19         500             23.2             14.2             19.4
## 10 2019-08-28         563             27               29               18  
## 11 2019-08-14         382             25               10               15  
## 12 2019-08-02         439             26               22               23  
## 13 2019-06-06         370             36               13               19  
## 14 2019-05-09         389             29               24               12  
## 15 2019-03-28         310             26.4             22.5              9.9
## # ... with 3 more variables: `Pete Buttigieg` &lt;dbl&gt;, `Amy Klobuchar` &lt;dbl&gt;,
## #   `Michael Bloomberg` &lt;dbl&gt;
```


---


```r
dim(nevadaPrimaries)
```

```
## [1] 76  4
```

```r
dim(wideNevada)
```

```
## [1] 15  8
```

---

- Or we could organize it into a time series ....


```r
timeNevada&lt;-pivot_wider(nevadaPrimaries, id_cols=candidate_name, 
                        names_from = c(start_date), values_from = pct)
timeNevada
```

```
## # A tibble: 6 x 16
##   candidate_name `2020-01-08` `2020-01-06` `2020-01-05` `2019-11-10`
##   &lt;chr&gt;                 &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;
## 1 Joseph R. Bid~         19.4           28           23           24
## 2 Bernard Sande~         17.6           29           17           18
## 3 Elizabeth War~         10.6           14           12           18
## 4 Pete Buttigieg          8.2            6            6            8
## 5 Amy Klobuchar           3.6            4            2            2
## 6 Michael Bloom~         NA             NA            2           NA
## # ... with 11 more variables: `2019-11-06` &lt;dbl&gt;, `2019-10-31` &lt;dbl&gt;,
## #   `2019-10-28` &lt;dbl&gt;, `2019-09-22` &lt;dbl&gt;, `2019-09-19` &lt;dbl&gt;,
## #   `2019-08-28` &lt;dbl&gt;, `2019-08-14` &lt;dbl&gt;, `2019-08-02` &lt;dbl&gt;,
## #   `2019-06-06` &lt;dbl&gt;, `2019-05-09` &lt;dbl&gt;, `2019-03-28` &lt;dbl&gt;
```


--- 


---


- Of course sometimes we want to do the reverse using `pivot_longer`
- In this case, we no longer have a single indicator variable for the values of `start_date`



```r
timeNevada %&gt;%
  select(candidate_name, `2020-01-08`, `2020-01-06`) %&gt;%
  pivot_longer(c(`2020-01-08`, `2020-01-06`), names_to = "start_date_test", values_to = "pct_test")
```

```
## # A tibble: 12 x 3
##    candidate_name      start_date_test pct_test
##    &lt;chr&gt;               &lt;chr&gt;              &lt;dbl&gt;
##  1 Joseph R. Biden Jr. 2020-01-08          19.4
##  2 Joseph R. Biden Jr. 2020-01-06          28  
##  3 Bernard Sanders     2020-01-08          17.6
##  4 Bernard Sanders     2020-01-06          29  
##  5 Elizabeth Warren    2020-01-08          10.6
##  6 Elizabeth Warren    2020-01-06          14  
##  7 Pete Buttigieg      2020-01-08           8.2
##  8 Pete Buttigieg      2020-01-06           6  
##  9 Amy Klobuchar       2020-01-08           3.6
## 10 Amy Klobuchar       2020-01-06           4  
## 11 Michael Bloomberg   2020-01-08          NA  
## 12 Michael Bloomberg   2020-01-06          NA
```


---

### Activity

- Re-organize the dataset so that there is only one row for each candidate-state dyad
- Feel free to limit this down to only the relevant candidates
- Compare the size of this dataset to our original dataset using the `object_size` command.
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
